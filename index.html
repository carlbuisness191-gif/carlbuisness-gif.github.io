<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Blockly HTML â€“ Learn HTML with Building Blocks</title>
  <meta name="description" content="Learn HTML using Blockly building blocks">
  <style>
    html, body {
      padding: 0;
      margin: 0;
    }
    #container {
      width: 100vw;
      height: 100vh;
      display: grid;
      grid-template-columns: 50% 50%;
      grid-template-rows: 50px 30px auto 45%;
      grid-template-areas:
        "blockly menubar"
        "blockly title"
        "blockly website"
        "blockly code";
    }
    #blocklyArea { grid-area: blockly; }
    #menubar {
      background: #a9d0f7;
      grid-area: menubar;
      font-family: sans-serif;
      font-size: 18px;
      padding: 5px 10px;
      display: grid;
      grid-template-columns: auto 36% auto;
      align-items: center;
    }
    #title {
      grid-area: title;
      width: 100%;
      background-color: #444;
      color: white;
      text-align: center;
      font-size: 20px;
      font-family: sans-serif;
      padding-top: 5px;
    }
    #websiteFrame {
      grid-area: website;
      border: 5px solid #444;
    }
    #sourcecode {
      grid-area: code;
      border: 5px solid lightgray;
      overflow: scroll;
      margin: 0;
      padding: 5px;
      font-family: monospace;
    }
    #website {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>

  <!-- Blockly Core -->
  <script src="blockly/blockly_compressed.js"></script>
  <script src="blockly/blocks_compressed.js"></script>
  <script src="blockly/javascript_compressed.js"></script>
  <script src="blockly/msg/js/en.js"></script>

  <!-- Your Blockly extensions -->
  <script src="en.js"></script>
  <script src="html_generators.js"></script>
  <script src="html_blocks.js"></script>
</head>
<body>
  <div id="container">
    <div id="blocklyArea"></div>
    <div id="menubar">
      <div><span id="saveText">ðŸ’¾ Save blocks:</span> <input type="button" value="Save" id="saveButton" /></div>
      <div><span id="loadText">ðŸ“‚ Load blocks:</span> <input type="file" id="fileButton" style="max-width:200px" /></div>
      <div><span id="exportText">ðŸ“„ Export webpage as HTML:</span> <input type="button" value="Export" id="exportButton" /></div>
    </div>
    <div id="title">Untitled Web Page</div>
    <div id="websiteFrame"><iframe id="website"></iframe></div>
    <pre id="sourcecode">Your HTML code will appear here.</pre>
  </div>

  <script>
    // Function to load local XML files
    function loadXMLDoc(filePath, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", filePath, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          callback(xhr.responseText);
        }
      };
      xhr.send(null);
    }

    // Load toolbox first
    loadXMLDoc('toolbox.xml', function(toolboxText) {
      var parser = new DOMParser();
      var toolboxXml = parser.parseFromString(toolboxText, "text/xml").documentElement;

      // Inject Blockly workspace
      var blocklyArea = document.getElementById('blocklyArea');
      var workspace = Blockly.inject(blocklyArea, {
        toolbox: toolboxXml,
        collapse: true,
        maxBlocks: Infinity,
        trashcan: true,
        media: 'blockly/media/',
        scrollbars: true,
        rtl: false,
        sounds: true,
        oneBasedIndex: true
      });

      // Load workspace.xml if exists
      loadXMLDoc('workspace.xml', function(wsText) {
        var wsXml = Blockly.Xml.textToDom(wsText);
        Blockly.Xml.domToWorkspace(wsXml, workspace);
      });

      // Update iframe and source code
      function updateWorkspace(event) {
        var code = HtmlGenerator.workspaceToCode(workspace);
        document.getElementById('sourcecode').innerText = code;
        document.getElementById('website').src = "data:text/html;charset=utf-8," + encodeURIComponent(code);

        var xmlDom = Blockly.Xml.workspaceToDom(workspace);
        localStorage.setItem('blockly-html-code', Blockly.Xml.domToText(xmlDom));
      }

      workspace.addChangeListener(updateWorkspace);

      // Save workspace XML
      document.getElementById("saveButton").onclick = function() {
        var xmlDom = Blockly.Xml.workspaceToDom(workspace);
        var xmlText = Blockly.Xml.domToText(xmlDom);
        window.open("data:application/octet-stream," + encodeURIComponent(xmlText), 'workspace.blockly.xml');
      };

      // Export HTML
      document.getElementById("exportButton").onclick = function() {
        var code = HtmlGenerator.workspaceToCode(workspace);
        window.open("data:application/octet-stream," + encodeURIComponent(code), 'webpage.html');
      };

      // Load workspace from file
      document.getElementById('fileButton').addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(ev) {
          var xmlText = ev.target.result;
          var xmlDom = Blockly.Xml.textToDom(xmlText);
          Blockly.Xml.domToWorkspace(xmlDom, workspace);
        };
        reader.readAsText(file);
      }, false);

    });
  </script>
</body>
</html>
